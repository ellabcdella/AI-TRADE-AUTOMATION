<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>INVOICE ë°ì´í„°í™”</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 20px; }
        .container-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .nav-link { font-weight: bold; color: #4e73df; margin-bottom: 20px; display: inline-block; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container-box">
        <a href="/" class="nav-link">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        <h2 class="mb-4">ğŸ“„ INVOICE ë°ì´í„°í™” ëŒ€ì‹œë³´ë“œ</h2>

        <div class="mb-4 p-3 border rounded bg-light">
            <h5>ìƒˆ INVOICE ì—…ë¡œë“œ (AI ë¶„ì„)</h5>
            <div class="input-group">
                <input type="file" id="fileInput" class="form-control" accept=".pdf">
                <button class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">ë°ì´í„° ì¶”ì¶œ ì‹œì‘</button>
            </div>
        </div>

        <div class="d-flex justify-content-between mb-3">
            <h4>ì¶”ì¶œ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸</h4>
            <button class="btn btn-success" onclick="downloadExcel()">ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover border">
                <thead class="table-primary text-center">
                    <tr>
                        <th>ë²ˆí˜¸/íŒŒì¼ëª…</th>
                        <th style="width: 25%;">ëŒ€í‘œìƒí’ˆ ë° ìƒì„¸ì„¤ëª…</th>
                        <th>ê¸ˆì•¡</th>
                        <th>Shipper / Consignee</th>
                        <th>POL / POD</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="invoiceList"></tbody>
            </table>
        </div>
    </div>

    <script>
        window.onload = loadInvoices;

        async function loadInvoices() {
            const res = await fetch('/get-invoices');
            const data = await res.json();
            const tbody = document.getElementById('invoiceList');
            tbody.innerHTML = '';

            data.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td class="small text-center">
                            <span class="fw-bold">${item.invoice_no}</span><br>
                            <span class="text-muted">${item.filename}</span>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm mb-1" value="${item.item_name || ''}" id="item_${item.invoice_no}" placeholder="ìƒí’ˆëª…">
                            <textarea class="form-control form-control-sm" id="desc_${item.invoice_no}" rows="2" placeholder="ìƒì„¸ ì„¤ëª…">${item.description_of_goods || ''}</textarea>
                        </td>
                        <td><input type="text" class="form-control form-control-sm" value="${item.total_amount}" id="amt_${item.invoice_no}"></td>
                        <td>
                            <input type="text" class="form-control form-control-sm mb-1" value="${item.shipper}" id="ship_${item.invoice_no}" placeholder="Shipper">
                            <input type="text" class="form-control form-control-sm" value="${item.consignee}" id="cons_${item.invoice_no}" placeholder="Consignee">
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm mb-1" value="${item.pol}" id="pol_${item.invoice_no}" placeholder="POL">
                            <input type="text" class="form-control form-control-sm" value="${item.pod}" id="pod_${item.invoice_no}" placeholder="POD">
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary mb-1 w-100" onclick="updateInvoice('${item.invoice_no}')">ì €ì¥</button>
                            <button class="btn btn-sm btn-danger w-100" onclick="deleteInvoice('${item.invoice_no}')">ì‚­ì œ</button>
                        </td>
                    </tr>`;
            });
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("íŒŒì¼ ì„ íƒ ìš”ë§");
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true; btn.innerText = "ë¶„ì„ì¤‘...";
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            await fetch('/analyze-document', { method: 'POST', body: formData });
            alert("ì™„ë£Œ");
            btn.disabled = false; btn.innerText = "ë°ì´í„° ì¶”ì¶œ ì‹œì‘";
            loadInvoices();
        }

        async function updateInvoice(invNo) {
            const payload = {
                invoice_no: invNo,
                total_amount: document.getElementById(`amt_${invNo}`).value,
                shipper: document.getElementById(`ship_${invNo}`).value,
                consignee: document.getElementById(`cons_${invNo}`).value,
                pol: document.getElementById(`pol_${invNo}`).value,
                pod: document.getElementById(`pod_${invNo}`).value,
                item_name: document.getElementById(`item_${invNo}`).value,
                description_of_goods: document.getElementById(`desc_${invNo}`).value
            };
            await fetch('/update-invoice', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function deleteInvoice(invNo) {
            if (confirm("ì‚­ì œí• ê¹Œìš”?")) {
                await fetch(`/delete-invoice/${invNo}`, { method: 'DELETE' });
                loadInvoices();
            }
        }

        function downloadExcel() { window.location.href = '/download-excel'; }
    </script>
</body>
</html>